name: Pipeline

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy environment"
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev
  push:
    branches:
      - main
      - develop
  pull_request:

jobs:
  backend:
    name: Backend checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    env:
      GOOGLE_API_KEY: test-google-api-key
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: backend/pyproject.toml
      - name: Install deps
        run: pip install ".[dev]"
      - name: Lint (ruff)
        run: python -m ruff check src
      - name: Tests
        run: python -m pytest

  frontend:
    name: Frontend checks
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json
      - name: Install deps
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Build
        run: npm run build

  build_and_push:
    name: Build and push images
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    if: github.event_name != 'pull_request'
    outputs:
      deploy_env: ${{ steps.resolve.outputs.deploy_env }}
      image_tag: ${{ steps.resolve.outputs.image_tag }}
      backend_image: ${{ steps.resolve.outputs.backend_image }}
      frontend_image: ${{ steps.resolve.outputs.frontend_image }}
      gcp_project_id: ${{ steps.resolve.outputs.gcp_project_id }}
      gar_region: ${{ steps.resolve.outputs.gar_region }}
      gar_repo: ${{ steps.resolve.outputs.gar_repo }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Resolve environment
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DEPLOY_ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            DEPLOY_ENV="prod"
          else
            DEPLOY_ENV="dev"
          fi
          if [ "$DEPLOY_ENV" = "prod" ]; then
            IMAGE_TAG="prod"
            SHOW_DEBUG="false"
            API_URL="${{ secrets.NEXT_PUBLIC_API_URL_PROD }}"
            GCP_PROJECT_ID="${{ secrets.GCP_PROJECT_ID_PROD }}"
            GAR_REGION="${{ secrets.GAR_REGION_PROD }}"
            GAR_REPO="${{ secrets.GAR_REPO_PROD }}"
            FIREBASE_API_KEY="${{ secrets.REACT_APP_FIREBASE_API_KEY_PROD }}"
            FIREBASE_AUTH_DOMAIN="${{ secrets.REACT_APP_FIREBASE_AUTH_DOMAIN_PROD }}"
            FIREBASE_PROJECT_ID="${{ secrets.REACT_APP_FIREBASE_PROJECT_ID_PROD }}"
            FIREBASE_STORAGE_BUCKET="${{ secrets.REACT_APP_FIREBASE_STORAGE_BUCKET_PROD }}"
            FIREBASE_MESSAGING_SENDER_ID="${{ secrets.REACT_APP_FIREBASE_MESSAGING_SENDER_ID_PROD }}"
            FIREBASE_APP_ID="${{ secrets.REACT_APP_FIREBASE_APP_ID_PROD }}"
            RECAPTCHA_SITE_KEY="${{ secrets.REACT_APP_RECAPTCHA_V3_SITE_KEY_PROD }}"
            APPCHECK_DEBUG_TOKEN="${{ secrets.REACT_APP_APPCHECK_DEBUG_TOKEN_PROD }}"
          else
            IMAGE_TAG="dev"
            SHOW_DEBUG="true"
            API_URL="${{ secrets.NEXT_PUBLIC_API_URL_DEV }}"
            GCP_PROJECT_ID="${{ secrets.GCP_PROJECT_ID_DEV }}"
            GAR_REGION="${{ secrets.GAR_REGION_DEV }}"
            GAR_REPO="${{ secrets.GAR_REPO_DEV }}"
            FIREBASE_API_KEY="${{ secrets.REACT_APP_FIREBASE_API_KEY_DEV }}"
            FIREBASE_AUTH_DOMAIN="${{ secrets.REACT_APP_FIREBASE_AUTH_DOMAIN_DEV }}"
            FIREBASE_PROJECT_ID="${{ secrets.REACT_APP_FIREBASE_PROJECT_ID_DEV }}"
            FIREBASE_STORAGE_BUCKET="${{ secrets.REACT_APP_FIREBASE_STORAGE_BUCKET_DEV }}"
            FIREBASE_MESSAGING_SENDER_ID="${{ secrets.REACT_APP_FIREBASE_MESSAGING_SENDER_ID_DEV }}"
            FIREBASE_APP_ID="${{ secrets.REACT_APP_FIREBASE_APP_ID_DEV }}"
            RECAPTCHA_SITE_KEY="${{ secrets.REACT_APP_RECAPTCHA_V3_SITE_KEY_DEV }}"
            APPCHECK_DEBUG_TOKEN="${{ secrets.REACT_APP_APPCHECK_DEBUG_TOKEN_DEV }}"
          fi
          echo "deploy_env=$DEPLOY_ENV" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "NEXT_PUBLIC_API_URL=$API_URL" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_SHOW_DEBUG=$SHOW_DEBUG" >> "$GITHUB_ENV"
          echo "REACT_APP_FIREBASE_API_KEY=$FIREBASE_API_KEY" >> "$GITHUB_ENV"
          echo "REACT_APP_FIREBASE_AUTH_DOMAIN=$FIREBASE_AUTH_DOMAIN" >> "$GITHUB_ENV"
          echo "REACT_APP_FIREBASE_PROJECT_ID=$FIREBASE_PROJECT_ID" >> "$GITHUB_ENV"
          echo "REACT_APP_FIREBASE_STORAGE_BUCKET=$FIREBASE_STORAGE_BUCKET" >> "$GITHUB_ENV"
          echo "REACT_APP_FIREBASE_MESSAGING_SENDER_ID=$FIREBASE_MESSAGING_SENDER_ID" >> "$GITHUB_ENV"
          echo "REACT_APP_FIREBASE_APP_ID=$FIREBASE_APP_ID" >> "$GITHUB_ENV"
          echo "REACT_APP_RECAPTCHA_V3_SITE_KEY=$RECAPTCHA_SITE_KEY" >> "$GITHUB_ENV"
          echo "REACT_APP_APPCHECK_DEBUG_TOKEN=$APPCHECK_DEBUG_TOKEN" >> "$GITHUB_ENV"
          echo "gcp_project_id=$GCP_PROJECT_ID" >> "$GITHUB_OUTPUT"
          echo "gar_region=$GAR_REGION" >> "$GITHUB_OUTPUT"
          echo "gar_repo=$GAR_REPO" >> "$GITHUB_OUTPUT"
          echo "backend_image=${GAR_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GAR_REPO}/ideaaudit-backend:$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "frontend_image=${GAR_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${GAR_REPO}/ideaaudit-frontend:$IMAGE_TAG" >> "$GITHUB_OUTPUT"
      - name: Authenticate to Google Cloud (dev)
        if: steps.resolve.outputs.deploy_env == 'dev'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}
      - name: Authenticate to Google Cloud (prod)
        if: steps.resolve.outputs.deploy_env == 'prod'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker ${{ steps.resolve.outputs.gar_region }}-docker.pkg.dev
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.resolve.outputs.backend_image }}
      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_SHOW_DEBUG=${{ env.NEXT_PUBLIC_SHOW_DEBUG }}
            REACT_APP_FIREBASE_API_KEY=${{ env.REACT_APP_FIREBASE_API_KEY }}
            REACT_APP_FIREBASE_AUTH_DOMAIN=${{ env.REACT_APP_FIREBASE_AUTH_DOMAIN }}
            REACT_APP_FIREBASE_PROJECT_ID=${{ env.REACT_APP_FIREBASE_PROJECT_ID }}
            REACT_APP_FIREBASE_STORAGE_BUCKET=${{ env.REACT_APP_FIREBASE_STORAGE_BUCKET }}
            REACT_APP_FIREBASE_MESSAGING_SENDER_ID=${{ env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}
            REACT_APP_FIREBASE_APP_ID=${{ env.REACT_APP_FIREBASE_APP_ID }}
            REACT_APP_RECAPTCHA_V3_SITE_KEY=${{ env.REACT_APP_RECAPTCHA_V3_SITE_KEY }}
            REACT_APP_APPCHECK_DEBUG_TOKEN=${{ env.REACT_APP_APPCHECK_DEBUG_TOKEN }}
          tags: ${{ steps.resolve.outputs.frontend_image }}

  deploy_dev:
    name: Deploy (dev)
    runs-on: ubuntu-latest
    needs: build_and_push
    if: >
      needs.build_and_push.outputs.deploy_env == 'dev' &&
      (github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_DEV }}
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
      - name: Deploy backend (dev)
        run: |
          gcloud run deploy "${{ secrets.CLOUD_RUN_BACKEND_SERVICE_DEV }}" \
            --image "${{ secrets.GAR_REGION_DEV }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_DEV }}/${{ secrets.GAR_REPO_DEV }}/ideaaudit-backend:dev" \
            --region "${{ secrets.GCP_REGION_DEV }}" \
            --project "${{ secrets.GCP_PROJECT_ID_DEV }}" \
            --allow-unauthenticated
      - name: Deploy frontend (dev)
        run: |
          gcloud run deploy "${{ secrets.CLOUD_RUN_FRONTEND_SERVICE_DEV }}" \
            --image "${{ secrets.GAR_REGION_DEV }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_DEV }}/${{ secrets.GAR_REPO_DEV }}/ideaaudit-frontend:dev" \
            --region "${{ secrets.GCP_REGION_DEV }}" \
            --project "${{ secrets.GCP_PROJECT_ID_DEV }}" \
            --allow-unauthenticated

  deploy_hosting_dev:
    name: Deploy Hosting (dev)
    runs-on: ubuntu-latest
    needs: deploy_dev
    if: >
      needs.build_and_push.outputs.deploy_env == 'dev' &&
      (github.ref == 'refs/heads/develop' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      - name: Deploy Firebase Hosting (dev)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase deploy --project "${{ secrets.GCP_PROJECT_ID_DEV }}" --only hosting --config firebase.dev.json

  deploy_prod:
    name: Deploy (prod)
    runs-on: ubuntu-latest
    needs: build_and_push
    if: >
      needs.build_and_push.outputs.deploy_env == 'prod' &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
      - name: Deploy backend (prod)
        run: |
          gcloud run deploy "${{ secrets.CLOUD_RUN_BACKEND_SERVICE_PROD }}" \
            --image "${{ secrets.GAR_REGION_PROD }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/${{ secrets.GAR_REPO_PROD }}/ideaaudit-backend:prod" \
            --region "${{ secrets.GCP_REGION_PROD }}" \
            --project "${{ secrets.GCP_PROJECT_ID_PROD }}" \
            --allow-unauthenticated
      - name: Deploy frontend (prod)
        run: |
          gcloud run deploy "${{ secrets.CLOUD_RUN_FRONTEND_SERVICE_PROD }}" \
            --image "${{ secrets.GAR_REGION_PROD }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID_PROD }}/${{ secrets.GAR_REPO_PROD }}/ideaaudit-frontend:prod" \
            --region "${{ secrets.GCP_REGION_PROD }}" \
            --project "${{ secrets.GCP_PROJECT_ID_PROD }}" \
            --allow-unauthenticated

  deploy_hosting_prod:
    name: Deploy Hosting (prod)
    runs-on: ubuntu-latest
    needs: deploy_prod
    if: >
      needs.build_and_push.outputs.deploy_env == 'prod' &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install Firebase CLI
        run: npm install -g firebase-tools
      - name: Deploy Firebase Hosting (prod)
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          firebase deploy --project "${{ secrets.GCP_PROJECT_ID_PROD }}" --only hosting --config firebase.prod.json
