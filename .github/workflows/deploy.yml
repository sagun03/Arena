name: Build and Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy environment"
        required: true
        type: choice
        options:
          - dev
          - prod
        default: dev
  push:
    branches:
      - main
      - develop

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    outputs:
      deploy_env: ${{ steps.resolve.outputs.deploy_env }}
      image_tag: ${{ steps.resolve.outputs.image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Resolve environment
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DEPLOY_ENV="${{ inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            DEPLOY_ENV="prod"
          else
            DEPLOY_ENV="dev"
          fi
          if [ "$DEPLOY_ENV" = "prod" ]; then
            IMAGE_TAG="prod"
            SHOW_DEBUG="false"
            API_URL="${{ secrets.NEXT_PUBLIC_API_URL_PROD }}"
          else
            IMAGE_TAG="dev"
            SHOW_DEBUG="true"
            API_URL="${{ secrets.NEXT_PUBLIC_API_URL_DEV }}"
          fi
          echo "deploy_env=$DEPLOY_ENV" >> "$GITHUB_OUTPUT"
          echo "image_tag=$IMAGE_TAG" >> "$GITHUB_OUTPUT"
          echo "NEXT_PUBLIC_API_URL=$API_URL" >> "$GITHUB_ENV"
          echo "NEXT_PUBLIC_SHOW_DEBUG=$SHOW_DEBUG" >> "$GITHUB_ENV"
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push backend
        uses: docker/build-push-action@v6
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/ideaaudit-backend:${{ steps.resolve.outputs.image_tag }}
            ghcr.io/${{ github.repository }}/ideaaudit-backend:${{ github.sha }}
      - name: Build and push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=${{ env.NEXT_PUBLIC_API_URL }}
            NEXT_PUBLIC_SHOW_DEBUG=${{ env.NEXT_PUBLIC_SHOW_DEBUG }}
          tags: |
            ghcr.io/${{ github.repository }}/ideaaudit-frontend:${{ steps.resolve.outputs.image_tag }}
            ghcr.io/${{ github.repository }}/ideaaudit-frontend:${{ github.sha }}

  deploy_dev:
    runs-on: ubuntu-latest
    needs: build_and_push
    if: needs.build_and_push.outputs.deploy_env == 'dev' && secrets.DEPLOY_HOST_DEV != ''
    steps:
      - name: Deploy (dev)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST_DEV }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            fi
            cd "${{ secrets.DEPLOY_PATH_DEV }}"
            export BACKEND_IMAGE="ghcr.io/${{ github.repository }}/ideaaudit-backend"
            export FRONTEND_IMAGE="ghcr.io/${{ github.repository }}/ideaaudit-frontend"
            export BACKEND_TAG="${{ needs.build_and_push.outputs.image_tag }}"
            export FRONTEND_TAG="${{ needs.build_and_push.outputs.image_tag }}"
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans

  deploy_prod:
    runs-on: ubuntu-latest
    needs: build_and_push
    if: needs.build_and_push.outputs.deploy_env == 'prod' && secrets.DEPLOY_HOST_PROD != ''
    steps:
      - name: Deploy (prod)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST_PROD }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          script: |
            if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u "${{ github.actor }}" --password-stdin
            fi
            cd "${{ secrets.DEPLOY_PATH_PROD }}"
            export BACKEND_IMAGE="ghcr.io/${{ github.repository }}/ideaaudit-backend"
            export FRONTEND_IMAGE="ghcr.io/${{ github.repository }}/ideaaudit-frontend"
            export BACKEND_TAG="${{ needs.build_and_push.outputs.image_tag }}"
            export FRONTEND_TAG="${{ needs.build_and_push.outputs.image_tag }}"
            docker compose -f docker-compose.prod.yml pull
            docker compose -f docker-compose.prod.yml up -d --remove-orphans
